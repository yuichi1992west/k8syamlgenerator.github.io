<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Kubernetes Pod Generator (CKAD Study Tool)</title>
    <style>
        :root {
            --primary-color: #326ce5; --border-color: #dee2e6; --background-color: #f8f9fa;
            --panel-background: #ffffff; --text-color: #212529; --label-color: #495057;
            --header-color: #004892; --pre-bg-color: #282c34; --pre-text-color: #abb2bf;
            --required-color: #dc3545; --notice-color: #0d6efd; --link-color: #0d6efd;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0; background-color: var(--background-color); color: var(--text-color);
            display: flex; flex-direction: column; height: 100vh;
        }
        .header {
            background: var(--primary-color); color: white; padding: 10px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .main-container { display: flex; flex: 1; overflow: hidden; }
        .input-panel, .output-panel {
            width: 50%; height: 100%; overflow-y: auto; padding: 20px; box-sizing: border-box;
        }
        .input-panel { border-right: 1px solid var(--border-color); }
        .output-panel-header { margin-bottom: 10px; }
        .output-panel-header .command {
            background: #e9ecef; border: 1px solid var(--border-color); border-radius: 4px; padding: 10px;
            font-family: 'Fira Code', monospace; font-size: 14px; white-space: nowrap; overflow-x: auto;
        }
        .output-panel-buttons { margin-top: 10px; display: flex; gap: 10px; align-items: center; }
        #yaml-output {
            width: 100%; height: calc(100% - 80px); margin: 0; padding: 15px; box-sizing: border-box;
            border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--pre-bg-color);
            color: var(--pre-text-color); font-family: 'Fira Code', monospace; font-size: 14px;
            line-height: 1.6; white-space: pre; overflow: auto; resize: none;
        }
        details {
            border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 15px;
            background-color: var(--panel-background);
        }
        summary {
            font-weight: 600; cursor: pointer; padding: 15px; color: var(--header-color);
            background-color: #f7faff; border-bottom: 1px solid transparent;
        }
        details[open] summary { border-bottom: 1px solid var(--border-color); }
        .content { padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label {
            display: block; font-weight: 500; margin-bottom: 8px; color: var(--label-color);
        }
        label a {
            margin-left: 8px; font-size: 12px; font-weight: normal; color: var(--link-color);
            text-decoration: none;
        }
        label a:hover { text-decoration: underline; }
        .required { color: var(--required-color); font-size: 12px; font-weight: bold; }
        .notice { color: var(--notice-color); font-size: 12px; font-weight: bold; }
        input[type="text"], input[type="number"], select {
            box-sizing: border-box; width: 100%; padding: 8px 12px;
            border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px;
        }
        .button {
            display: inline-block; background-color: var(--primary-color); color: white; padding: 8px 15px;
            border: none; border-radius: 4px; cursor: pointer; font-size: 14px; text-align: center;
        }
        .button.secondary { background-color: #6c757d; }
        .button.danger { background-color: #dc3545; }
        .dynamic-list-item {
            border: 1px dashed var(--border-color); padding: 15px; margin-bottom: 10px;
            border-radius: 4px; background: #fafafa; display: grid; grid-template-columns: 1fr 1fr auto;
            gap: 10px; align-items: end;
        }
        /* Switch for CKAD Mode */
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(26px); }
    </style>
</head>
<body>
    <header class="header">
        <h2>Interactive K8s Pod Generator</h2>
        <button type="button" class="button secondary" id="load-nginx-sample">Nginxサンプルを読み込む</button>
    </header>

    <main class="main-container">
        <div class="input-panel">
            <form id="kube-form">
                <details open>
                    <summary>Metadata</summary>
                    <div class="content">
                        <div class="form-group">
                            <label for="podName">Pod Name <span class="required">(入力必須)</span><a href="https://k8s.io/docs/concepts/overview/working-with-objects/names/" target="_blank">Doc</a></label>
                            <input type="text" id="podName" value="my-pod">
                        </div>
                        <div class="form-group">
                            <label>Labels <a href="https://k8s.io/docs/concepts/overview/working-with-objects/labels/" target="_blank">Doc</a></label>
                            <div id="labels-list" class="dynamic-list"></div>
                            <button type="button" class="button" onclick="addKeyValueItem('labels')">+ Add Label</button>
                        </div>
                         <div class="form-group">
                            <label>Annotations <a href="https://k8s.io/docs/concepts/overview/working-with-objects/annotations/" target="_blank">Doc</a></label>
                            <div id="annotations-list" class="dynamic-list"></div>
                            <button type="button" class="button" onclick="addKeyValueItem('annotations')">+ Add Annotation</button>
                        </div>
                    </div>
                </details>

                <details open>
                    <summary>Pod Spec</summary>
                    <div class="content">
                        <div class="form-group">
                            <label for="serviceAccountName">ServiceAccount Name <a href="https://k8s.io/docs/tasks/configure-pod-container/configure-service-account/" target="_blank">Doc</a></label>
                            <input type="text" id="serviceAccountName" placeholder="(default)">
                        </div>
                        <div class="form-group">
                            <label for="restartPolicy">Restart Policy <a href="https://k8s.io/docs/concepts/workloads/pods/pod-lifecycle/#restart-policy" target="_blank">Doc</a></label>
                            <select id="restartPolicy">
                                <option>Always</option>
                                <option>OnFailure</option>
                                <option>Never</option>
                            </select>
                        </div>
                    </div>
                </details>

                <details open>
                    <summary>Containers</summary>
                    <div class="content">
                        <div class="form-group">
                            <label for="containerName">Container Name <span class="required">(入力必須)</span></label>
                             <input type="text" id="containerName" value="main-container">
                        </div>
                        <div class="form-group">
                            <label for="imageName">Image <span class="required">(入力必須)</span><a href="https://k8s.io/docs/concepts/containers/images/" target="_blank">Doc</a></label>
                            <input type="text" id="imageName" value="nginx:latest">
                        </div>
                        <div class="form-group">
                             <label>Command <a href="https://k8s.io/docs/tasks/inject-data-application/define-command-argument-container/" target="_blank">Doc</a></label>
                             <div id="command-list" class="dynamic-list single-value"></div>
                             <button type="button" class="button" onclick="addSingleValueItem('command')">+ Add Command</button>
                        </div>
                         <div class="form-group">
                             <label>Args <a href="https://k8s.io/docs/tasks/inject-data-application/define-command-argument-container/" target="_blank">Doc</a></label>
                             <div id="args-list" class="dynamic-list single-value"></div>
                             <button type="button" class="button" onclick="addSingleValueItem('args')">+ Add Argument</button>
                        </div>
                    </div>
                </details>

                </form>
        </div>
        <div class="output-panel">
            <div class="output-panel-header">
                <div class="output-panel-buttons">
                    <button type="button" class="button" id="copy-yaml-btn">YAMLをコピー</button>
                    <button type="button" class="button secondary" id="save-yaml-btn">ファイルに保存</button>
                    <div style="margin-left:auto; text-align:right;">
                        <label for="ckad-mode-toggle" style="font-size:14px; margin-bottom:5px;">CKAD対策モード</label>
                        <label class="switch">
                            <input type="checkbox" id="ckad-mode-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
                 <div id="deploy-command" class="command" style="margin-top:10px;"></div>
            </div>
            <textarea id="yaml-output" readonly></textarea>
        </div>
    </main>

    <template id="key-value-template">
        <div class="dynamic-list-item">
            <div><input type="text" class="item-key" placeholder="Key"></div>
            <div><input type="text" class="item-value" placeholder="Value"></div>
            <button type="button" class="button danger" onclick="this.parentElement.remove()">Remove</button>
        </div>
    </template>
    <template id="single-value-template">
        <div class="dynamic-list-item" style="grid-template-columns: 1fr auto;">
            <div><input type="text" class="item-value" placeholder="Value"></div>
            <button type="button" class="button danger" onclick="this.parentElement.remove()">Remove</button>
        </div>
    </template>

    <script>
        const form = document.getElementById('kube-form');
        const yamlOutput = document.getElementById('yaml-output');

        function addKeyValueItem(type) {
            const list = document.getElementById(`${type}-list`);
            const template = document.getElementById('key-value-template').content.cloneNode(true);
            list.appendChild(template);
        }

        function addSingleValueItem(type) {
             const list = document.getElementById(`${type}-list`);
            const template = document.getElementById('single-value-template').content.cloneNode(true);
            list.appendChild(template);
        }

        function generateYaml() {
            const ckadMode = document.getElementById('ckad-mode-toggle').checked;
            const state = {
                podName: document.getElementById('podName').value,
                labels: Array.from(document.querySelectorAll('#labels-list .dynamic-list-item')).map(item => ({ key: item.querySelector('.item-key').value, value: item.querySelector('.item-value').value })).filter(i => i.key),
                annotations: Array.from(document.querySelectorAll('#annotations-list .dynamic-list-item')).map(item => ({ key: item.querySelector('.item-key').value, value: item.querySelector('.item-value').value })).filter(i => i.key),
                serviceAccountName: document.getElementById('serviceAccountName').value,
                restartPolicy: document.getElementById('restartPolicy').value,
                containerName: document.getElementById('containerName').value,
                imageName: document.getElementById('imageName').value,
                command: Array.from(document.querySelectorAll('#command-list .item-value')).map(i => i.value).filter(Boolean),
                args: Array.from(document.querySelectorAll('#args-list .item-value')).map(i => i.value).filter(Boolean),
            };

            const c = (text) => ckadMode ? `\n${text}` : '';

            let yaml = `apiVersion: v1
kind: Pod`;
            
            yaml += c(`# PodやServiceなどのAPIオブジェクトを識別するためのデータ`);
            yaml += `\nmetadata:`;
            yaml += c(`  # Podの名前 (必須)`);
            yaml += `\n  name: ${state.podName}`;

            if (state.labels.length > 0) {
                yaml += c(`  # オブジェクトを整理・選択するためのKey-Valueペア`);
                yaml += `\n  labels:`;
                state.labels.forEach(l => { yaml += `\n    ${l.key}: ${l.value}`; });
            }
            if (state.annotations.length > 0) {
                yaml += c(`  # ツールなどが利用する、識別目的ではない任意のメタデータ`);
                yaml += `\n  annotations:`;
                state.annotations.forEach(a => { yaml += `\n    ${a.key}: ${a.value}`; });
            }

            yaml += c(`\n# Podの望ましい状態を定義するSpec`);
            yaml += `\nspec:`;
            
            if (state.serviceAccountName) {
                yaml += c(`\n  # PodがAPIサーバーと通信する際に使用するサービスアカウント`);
                yaml += `\n  serviceAccountName: ${state.serviceAccountName}`;
            }

            yaml += c(`\n  # Pod内のコンテナが終了した際の再起動ポリシー (Always, OnFailure, Never)`);
            yaml += `\n  restartPolicy: ${state.restartPolicy}`;

            yaml += c(`\n  # Pod内で実行されるコンテナのリスト (最低1つは必須)`);
            yaml += `\n  containers:`;
            yaml += c(`  - name: ${state.containerName}  # コンテナ名 (必須)`);
            yaml += `\n    image: ${state.imageName}`;
            
            if (state.command.length > 0) {
                 yaml += c(`\n    # コンテナのデフォルトENTRYPOINTを上書き`);
                 yaml += `\n    command: [${state.command.map(c => `"${c}"`).join(', ')}]`;
            }
            if (state.args.length > 0) {
                 yaml += c(`\n    # コンテナのデフォルトCMDを上書き`);
                 yaml += `\n    args: [${state.args.map(a => `"${a}"`).join(', ')}]`;
            }
            
            yamlOutput.value = yaml;
            document.getElementById('deploy-command').textContent = `kubectl apply -f ${state.podName || 'pod'}.yaml`;
        }

        // --- Event Listeners ---
        form.addEventListener('input', generateYaml);
        document.body.addEventListener('click', (e) => {
            if (e.target.closest('.danger')) generateYaml();
        });
        document.getElementById('ckad-mode-toggle').addEventListener('change', generateYaml);

        document.getElementById('copy-yaml-btn').addEventListener('click', () => {
            navigator.clipboard.writeText(yamlOutput.value).then(() => alert('Copied!'));
        });
        document.getElementById('save-yaml-btn').addEventListener('click', () => {
            const filename = (document.getElementById('podName').value || 'pod') + '.yaml';
            const blob = new Blob([yamlOutput.value], { type: 'text/yaml' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            URL.revokeObjectURL(link.href);
        });
        document.getElementById('load-nginx-sample').addEventListener('click', () => {
            form.reset();
            document.querySelectorAll('.dynamic-list').forEach(list => list.innerHTML = '');
            document.getElementById('podName').value = 'nginx-pod-example';
            addKeyValueItem('labels');
            document.querySelector('#labels-list .item-key').value = 'app';
            document.querySelector('#labels-list .item-value').value = 'nginx';
            document.getElementById('containerName').value = 'nginx-container';
            document.getElementById('imageName').value = 'nginx:1.27.1';
            generateYaml();
            alert('Nginx Podのサンプルを読み込みました。');
        });

        document.addEventListener('DOMContentLoaded', generateYaml);
    </script>
</body>
</html>